# YModem 固件传输工具

这是一个用于通过串口发送固件文件的 YModem 协议实现。支持完整的固件传输，包括分块传输、重传机制和详细的进度显示。

## 功能特点

- ✅ **完整文件传输** - 自动将固件文件分块传输（每块1024字节）
- ✅ **自动重传机制** - 传输失败时自动重试（可配置重试次数）
- ✅ **进度显示** - 实时显示传输进度和状态
- ✅ **详细模式** - 可选的详细输出模式，用于调试
- ✅ **错误处理** - 完善的错误检测和处理机制
- ✅ **YModem 协议** - 完整实现YModem协议规范

## 文件结构

```
iap_py/
├── main.py              # 主程序入口
├── serial_manager.py    # 串口管理器
├── ymodem.py           # YModem协议实现
├── bin_reader.py       # 二进制文件读取器
├── test_transmission.py # 传输逻辑测试脚本
├── firmware/           # 固件文件目录
│   └── App_crc.bin     # 示例固件文件
└── README.md           # 使用说明
```

## 使用方法

### 基本用法

```bash
# 基本传输（使用默认参数）
python main.py --port COM3

# 指定波特率
python main.py --port COM3 --baud 115200

# 指定固件文件
python main.py --port COM3 --file firmware/my_firmware.bin
```

### 高级选项

```bash
# 详细模式（显示完整的传输过程）
python main.py --port COM3 --verbose

# 自定义超时时间和重试次数
python main.py --port COM3 --timeout 10 --retries 5

# 组合使用多个选项
python main.py --port COM3 --baud 115200 --file firmware/App_crc.bin --timeout 8 --retries 3 --verbose
```

### 命令行参数说明

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `--port` | 串口号（必需） | 无 | `COM3`, `/dev/ttyUSB0` |
| `--baud` | 波特率 | 115200 | `9600`, `115200`, `921600` |
| `--file` | 固件文件路径 | `firmware/App_crc.bin` | `firmware/my_app.bin` |
| `--timeout` | ACK等待超时时间（秒） | 5 | `10` |
| `--retries` | 每个数据包重试次数 | 3 | `5` |
| `--verbose` | 详细输出模式 | 关闭 | 添加此参数启用 |

## 传输流程

程序按照标准 YModem 协议执行以下步骤：

### 1. 文件信息传输
- 发送第0包（包含文件名和大小）
- 等待下位机返回 ACK + C 响应

### 2. 数据传输
- 将文件分块为1024字节的数据包
- 按序号发送每个数据包
- 每个数据包等待 ACK 响应
- 失败时自动重传（最多重试指定次数）

### 3. 传输结束
- 发送 EOT（End of Transmission）字符
- 发送空文件名包表示传输完全结束
- 等待最终 ACK 确认

## 输出示例

### 普通模式输出

```
正在连接串口 COM3，波特率 115200...
文件信息：App_crc.bin, 大小：45678 字节
将分为 45 个数据包传输

发送第0包（文件信息包）... 完成(1029字节)
等待ACK+C... 完成

开始发送数据包（共45包）...
发送第1/45包 [2%]... 完成(1029字节)
等待ACK... ACK
发送第2/45包 [4%]... 完成(1029字节)
等待ACK... ACK
...
发送第45/45包 [100%]... 完成(1029字节)
等待ACK... ACK

=== 发送传输结束信号 ===
发送EOT字符...
等待ACK... ACK

=== 发送最终结束包 ===
等待下位机请求下一个文件...
收到：0x43
✓ 收到C字符，下位机请求下一个文件
发送空文件名包（传输结束标志）...
等待ACK... ACK
✓ 收到最终ACK，传输完全结束

🎉 YModem完整传输流程完成！
- 文件信息包发送成功
- 数据包发送成功（共45包）
- 传输结束信号发送完成
- 总传输字节数：45678 字节

✅ 传输任务完成！
```

### 详细模式输出

使用 `--verbose` 参数时，会显示更多详细信息：
- 每个数据包的十六进制内容预览
- 详细的协议交互过程
- 完整的应答信息
- 错误和重传的详细说明

## 测试功能

运行测试脚本验证传输逻辑：

```bash
python test_transmission.py
```

测试脚本会验证：
- 文件分块逻辑是否正确
- 数据包构建是否符合协议规范
- 数据完整性检查

## 错误处理

程序具有完善的错误处理机制：

### 常见错误及解决方法

1. **串口连接失败**
   ```
   错误：无法连接串口 COM3
   ```
   - 检查串口号是否正确
   - 确认串口未被其他程序占用
   - 检查串口权限（Linux下）

2. **文件不存在**
   ```
   错误：文件 firmware/App_crc.bin 不存在
   ```
   - 检查文件路径是否正确
   - 确认文件确实存在

3. **传输超时**
   ```
   第5包未收到ACK，准备重传...
   ```
   - 检查下位机是否正常运行
   - 尝试增加超时时间 `--timeout 10`
   - 检查波特率设置是否匹配

4. **重传失败**
   ```
   第5包发送失败，已重试3次
   ```
   - 检查串口连接稳定性
   - 尝试增加重试次数 `--retries 5`
   - 检查下位机固件是否支持YModem协议

## 协议规范

本程序实现的 YModem 协议特点：

- **数据包大小**：1024字节（使用STX起始标记）
- **校验方式**：CRC-16/XMODEM
- **包序号**：8位序号 + 8位序号取反
- **填充字符**：数据包用0x1A填充，文件信息包用0x00填充

## 技术细节

### 类设计原则

按照面向对象编程最佳实践：

1. **SerialManager** - 封装串口通信逻辑
2. **YModem** - 封装协议处理逻辑  
3. **BinReader** - 封装文件读取逻辑

### 模块化设计

- 每个模块职责单一，便于测试和维护
- 所有公共API都有详细的文档注释
- 错误处理统一且完善

## 注意事项

1. **下位机协议兼容性** - 确保下位机支持标准YModem协议
2. **超时设置** - 根据下位机响应速度调整超时时间
3. **文件大小** - 大文件传输时间较长，请耐心等待
4. **串口稳定性** - 使用质量好的串口线，确保连接稳定

---

如有问题，请检查错误信息并参考本说明文档的错误处理部分。 